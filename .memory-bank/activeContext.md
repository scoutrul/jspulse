# Active Context

## Текущий фокус
- Структурирование Memory Bank: вынос правил стиля, комментирования и взаимодействия в отдельные файлы.
- Актуализация архитектурных и технологических решений.
- Внедрение автоматизации: всегда предлагать команды для коммита без запроса.

## Последние изменения
- Созданы файлы codeStyle.md и interactionRules.md.
- Обновлены systemPatterns.md и techContext.md.

## Следующие шаги
- Поддерживать актуальность Memory Bank при изменениях архитектуры, процессов и правил.
- Фиксировать новые паттерны и процессы в соответствующих файлах.

# Активный контекст проекта JSPulse

## Решение проблемы пагинации

### Обнаруженные проблемы и их решения

1. **Типизация и преобразование параметров запросов**
   - Параметры пагинации (page, limit) приходили как строки, но MongoDB ожидает числа
   - Middleware валидации создавал `req.validatedQuery`, но не обновлял `req.query`
   - Решение: использование `z.coerce.number()` для преобразования и обновление обоих объектов

2. **Хранение состояния на фронтенде**
   - Использование `sessionStorage` вместо `localStorage` приводило к потере состояния между вкладками
   - Решение: переход на `localStorage` и добавление синхронизации между вкладками через событие `storage`

3. **Обработка ошибок в API**
   - Непоследовательная обработка ошибок приводила к неинформативным сообщениям
   - Решение: унифицированный подход к обработке ошибок на всех уровнях

4. **Типизация в Svelte-компонентах**
   - Некорректная типизация для `createEventDispatcher` приводила к проблемам с событиями
   - Решение: явное указание типов для всех диспетчеров событий

### Выводы и рекомендации

1. **Архитектурные решения**
   - Четко разделять ответственность между middleware и обработчиками маршрутов
   - Middleware должны трансформировать данные, но не заменять их полностью
   - Валидация должна гарантировать типы данных для следующих обработчиков

2. **Работа с MongoDB**
   - Всегда явно преобразовывать параметры пагинации в числа перед использованием в `.skip()` и `.limit()`
   - Использовать `.lean()` для оптимизации запросов, особенно при пагинации
   - Проверять сложные запросы в изолированных тестовых скриптах

3. **Фронтенд-разработка**
   - Использовать `localStorage` для хранения состояния между сессиями
   - Реализовывать синхронизацию между вкладками через события `storage`
   - Правильно типизировать события в Svelte-компонентах

4. **Предотвращение ошибок**
   - Создавать тестовые скрипты для верификации критических функций (например, пагинации в БД)
   - Использовать тестовые маршруты API для диагностики без middleware
   - Добавлять подробное логирование параметров запросов в процессе отладки

5. **Работа с Zod**
   - Использовать `z.coerce.number()` для автоматического преобразования строк в числа
   - Явно обрабатывать ошибки валидации и возвращать информативные сообщения
   - Применять дефолтные значения для необязательных параметров

Эти уроки помогут в дальнейшей разработке проекта и предотвратят подобные проблемы в будущем. 